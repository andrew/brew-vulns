# frozen_string_literal: true

require "test_helper"

class TestVulnerability < Minitest::Test
  include SilenceOutput

  def test_parses_basic_vulnerability
    data = {
      "id" => "CVE-2024-1234",
      "summary" => "Buffer overflow in example function",
      "details" => "Detailed description of the vulnerability",
      "aliases" => ["GHSA-xxxx-yyyy-zzzz"]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "CVE-2024-1234", vuln.id
    assert_equal "Buffer overflow in example function", vuln.summary
    assert_equal ["GHSA-xxxx-yyyy-zzzz"], vuln.aliases
  end

  def test_extracts_severity_from_cvss_critical
    data = {
      "id" => "CVE-2024-1234",
      "severity" => [{ "type" => "CVSS_V3", "score" => "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H" }]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "CRITICAL", vuln.severity_display
    assert_equal 4, vuln.severity_level
  end

  def test_extracts_severity_from_cvss_high
    data = {
      "id" => "CVE-2024-1234",
      "severity" => [{ "type" => "CVSS_V3", "score" => "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:L/A:N" }]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "HIGH", vuln.severity_display
    assert_equal 3, vuln.severity_level
  end

  def test_extracts_severity_from_cvss_medium
    data = {
      "id" => "CVE-2024-1234",
      "severity" => [{ "type" => "CVSS_V3", "score" => "CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N" }]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "MEDIUM", vuln.severity_display
    assert_equal 2, vuln.severity_level
  end

  def test_extracts_severity_from_cvss_low
    data = {
      "id" => "CVE-2024-1234",
      "severity" => [{ "type" => "CVSS_V3", "score" => "CVSS:3.1/AV:L/AC:H/PR:H/UI:R/S:U/C:L/I:N/A:N" }]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "LOW", vuln.severity_display
    assert_equal 1, vuln.severity_level
  end

  def test_extracts_severity_from_database_specific
    data = {
      "id" => "CVE-2024-1234",
      "database_specific" => { "severity" => "HIGH" }
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "HIGH", vuln.severity_display
    assert_equal 3, vuln.severity_level
  end

  def test_extracts_severity_from_affected_database_specific
    data = {
      "id" => "CVE-2024-1234",
      "affected" => [
        { "database_specific" => { "severity" => "MEDIUM" } }
      ]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "MEDIUM", vuln.severity_display
    assert_equal 2, vuln.severity_level
  end

  def test_normalizes_moderate_to_medium
    data = {
      "id" => "CVE-2024-1234",
      "database_specific" => { "severity" => "MODERATE" }
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "MEDIUM", vuln.severity_display
  end

  def test_returns_unknown_when_no_severity
    data = { "id" => "CVE-2024-1234" }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "UNKNOWN", vuln.severity_display
    assert_equal 0, vuln.severity_level
  end

  def test_cve_ids_extracts_cves_from_id_and_aliases
    data = {
      "id" => "CVE-2024-1234",
      "aliases" => ["GHSA-xxxx-yyyy-zzzz", "CVE-2024-5678"]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_includes vuln.cve_ids, "CVE-2024-1234"
    assert_includes vuln.cve_ids, "CVE-2024-5678"
    refute_includes vuln.cve_ids, "GHSA-xxxx-yyyy-zzzz"
  end

  def test_fixed_versions_extracts_from_affected_ranges
    data = {
      "id" => "CVE-2024-1234",
      "affected" => [
        {
          "ranges" => [
            {
              "type" => "GIT",
              "events" => [
                { "introduced" => "0" },
                { "fixed" => "v1.2.3" }
              ]
            }
          ]
        }
      ]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal ["v1.2.3"], vuln.fixed_versions
  end

  def test_fixed_versions_deduplicates
    data = {
      "id" => "CVE-2024-1234",
      "affected" => [
        {
          "ranges" => [
            { "events" => [{ "fixed" => "v1.0.0" }] },
            { "events" => [{ "fixed" => "v1.0.0" }] }
          ]
        }
      ]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal ["v1.0.0"], vuln.fixed_versions
  end

  def test_advisory_url
    data = {
      "id" => "CVE-2024-1234",
      "references" => [
        { "type" => "WEB", "url" => "https://example.com" },
        { "type" => "ADVISORY", "url" => "https://security.example.com/advisory" }
      ]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal "https://security.example.com/advisory", vuln.advisory_url
  end

  def test_fix_urls
    data = {
      "id" => "CVE-2024-1234",
      "references" => [
        { "type" => "FIX", "url" => "https://github.com/example/commit/abc123" },
        { "type" => "FIX", "url" => "https://github.com/example/commit/def456" },
        { "type" => "WEB", "url" => "https://example.com" }
      ]
    }

    vuln = Brew::Vulns::Vulnerability.new(data)

    assert_equal 2, vuln.fix_urls.size
    assert_includes vuln.fix_urls, "https://github.com/example/commit/abc123"
  end

  def test_from_osv_list_creates_array_of_vulnerabilities
    vulns_data = [
      { "id" => "CVE-2024-1111" },
      { "id" => "CVE-2024-2222" }
    ]

    vulns = Brew::Vulns::Vulnerability.from_osv_list(vulns_data)

    assert_equal 2, vulns.size
    assert_instance_of Brew::Vulns::Vulnerability, vulns.first
    assert_equal "CVE-2024-1111", vulns.first.id
  end

  def test_affects_version_returns_true_when_no_affected_data
    data = { "id" => "CVE-2024-1234" }
    vuln = Brew::Vulns::Vulnerability.new(data)

    assert vuln.affects_version?("1.0.0")
  end

  def test_affects_version_matches_explicit_versions
    data = {
      "id" => "CVE-2024-1234",
      "affected" => [
        { "versions" => ["1.0.0", "1.0.1", "v1.0.2"] }
      ]
    }
    vuln = Brew::Vulns::Vulnerability.new(data)

    assert vuln.affects_version?("1.0.0")
    assert vuln.affects_version?("v1.0.0")
    assert vuln.affects_version?("1.0.2")
    refute vuln.affects_version?("2.0.0")
  end

  def test_affects_version_checks_semver_ranges
    data = {
      "id" => "CVE-2024-1234",
      "affected" => [
        {
          "ranges" => [
            {
              "type" => "SEMVER",
              "events" => [
                { "introduced" => "1.0.0" },
                { "fixed" => "1.5.0" }
              ]
            }
          ]
        }
      ]
    }
    vuln = Brew::Vulns::Vulnerability.new(data)

    assert vuln.affects_version?("1.2.0")
    assert vuln.affects_version?("1.4.9")
    refute vuln.affects_version?("1.5.0")
    refute vuln.affects_version?("2.0.0")
    refute vuln.affects_version?("0.9.0")
  end

  def test_affects_version_ignores_git_ranges
    data = {
      "id" => "CVE-2024-1234",
      "affected" => [
        {
          "ranges" => [
            {
              "type" => "GIT",
              "events" => [
                { "introduced" => "abc123" },
                { "fixed" => "def456" }
              ]
            }
          ]
        }
      ]
    }
    vuln = Brew::Vulns::Vulnerability.new(data)

    refute vuln.affects_version?("1.0.0")
  end

  def test_affects_version_extracts_ecosystem_from_purl
    data = {
      "id" => "CVE-2024-1234",
      "affected" => [
        {
          "package" => {
            "purl" => "pkg:npm/lodash"
          },
          "ranges" => [
            {
              "type" => "SEMVER",
              "events" => [
                { "introduced" => "0" },
                { "fixed" => "4.17.21" }
              ]
            }
          ]
        }
      ]
    }
    vuln = Brew::Vulns::Vulnerability.new(data)

    assert vuln.affects_version?("4.17.20")
    refute vuln.affects_version?("4.17.21")
  end

  def test_affects_version_handles_last_affected
    data = {
      "id" => "CVE-2024-1234",
      "affected" => [
        {
          "ranges" => [
            {
              "type" => "SEMVER",
              "events" => [
                { "introduced" => "1.0.0" },
                { "last_affected" => "1.5.0" }
              ]
            }
          ]
        }
      ]
    }
    vuln = Brew::Vulns::Vulnerability.new(data)

    assert vuln.affects_version?("1.5.0")
    refute vuln.affects_version?("1.5.1")
  end
end
